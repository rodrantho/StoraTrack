{% extends "base.html" %}

{% block title %}GestiÃ³n de Tags{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <h1><i class="bi bi-tags"></i> GestiÃ³n de Tags</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTagModal">
        <i class="bi bi-plus-lg"></i> Nuevo Tag
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Buscar</label>
                <input type="text" class="form-control" name="search" value="{{ request.args.get('search', '') }}" placeholder="Nombre, descripciÃ³n...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Empresa</label>
                <select class="form-select" name="company">
                    <option value="">Todas</option>
                    {% for company in companies %}
                    <option value="{{ company.id }}" {{ 'selected' if request.args.get('company') == company.id|string }}>{{ company.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Color</label>
                <select class="form-select" name="color">
                    <option value="">Todos</option>
                    <option value="primary" {{ 'selected' if request.args.get('color') == 'primary' }}>ðŸ”µ Azul</option>
                    <option value="success" {{ 'selected' if request.args.get('color') == 'success' }}>ðŸŸ¢ Verde</option>
                    <option value="warning" {{ 'selected' if request.args.get('color') == 'warning' }}>ðŸŸ¡ Amarillo</option>
                    <option value="danger" {{ 'selected' if request.args.get('color') == 'danger' }}>ðŸ”´ Rojo</option>
                    <option value="info" {{ 'selected' if request.args.get('color') == 'info' }}>ðŸ”µ Celeste</option>
                    <option value="secondary" {{ 'selected' if request.args.get('color') == 'secondary' }}>âš« Gris</option>
                    <option value="dark" {{ 'selected' if request.args.get('color') == 'dark' }}>âš« Negro</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Resumen -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h4 class="text-primary">{{ summary.total }}</h4>
                <small class="text-muted">Total Tags</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h4 class="text-success">{{ summary.in_use }}</h4>
                <small class="text-muted">En Uso</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h4 class="text-warning">{{ summary.most_used_count }}</h4>
                <small class="text-muted">MÃ¡s Usado</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h4 class="text-info">{{ summary.companies_count }}</h4>
                <small class="text-muted">Empresas</small>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Tags -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-collection"></i> Tags del Sistema</h5>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="toggleView('grid')" id="gridViewBtn">
                    <i class="bi bi-grid-3x3-gap"></i> Vista CuadrÃ­cula
                </button>
                <button class="btn btn-outline-secondary active" onclick="toggleView('list')" id="listViewBtn">
                    <i class="bi bi-list"></i> Vista Lista
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if tags %}
        <!-- Vista Lista -->
        <div id="listView" class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Tag</th>
                        <th>Empresa</th>
                        <th>DescripciÃ³n</th>
                        <th>Equipos</th>
                        <th>Creado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tag in tags %}
                    <tr>
                        <td>
                            <span class="badge bg-{{ tag.color }} fs-6">
                                <i class="bi bi-tag"></i> {{ tag.name }}
                            </span>
                        </td>
                        <td>{{ tag.company.name }}</td>
                        <td>
                            <span class="text-muted">{{ tag.description or 'Sin descripciÃ³n' }}</span>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">{{ tag.device_count }} equipos</span>
                        </td>
                        <td>
                            <small class="text-muted">{{ tag.created_at.strftime('%d/%m/%Y') }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewTag({{ tag.id }})" title="Ver detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="editTag({{ tag.id }})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="confirmDeleteTag({{ tag.id }}, '{{ tag.name }}')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Vista CuadrÃ­cula -->
        <div id="gridView" class="p-3" style="display: none;">
            <div class="row g-3">
                {% for tag in tags %}
                <div class="col-md-4 col-lg-3">
                    <div class="card tag-card h-100">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <span class="badge bg-{{ tag.color }} fs-4 p-3">
                                    <i class="bi bi-tag"></i> {{ tag.name }}
                                </span>
                            </div>
                            <h6 class="card-title">{{ tag.company.name }}</h6>
                            <p class="card-text text-muted small">{{ tag.description or 'Sin descripciÃ³n' }}</p>
                            <div class="mb-3">
                                <span class="badge bg-light text-dark">{{ tag.device_count }} equipos</span>
                            </div>
                            <div class="btn-group btn-group-sm w-100">
                                <button class="btn btn-outline-info" onclick="viewTag({{ tag.id }})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="editTag({{ tag.id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="confirmDeleteTag({{ tag.id }}, '{{ tag.name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-footer text-muted text-center">
                            <small>Creado: {{ tag.created_at.strftime('%d/%m/%Y') }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-tags text-muted" style="font-size: 3rem;"></i>
            <h5 class="text-muted mt-3">No hay tags registrados</h5>
            <p class="text-muted">Comienza creando el primer tag del sistema.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTagModal">
                <i class="bi bi-plus-lg"></i> Crear Primer Tag
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Crear Tag -->
<div class="modal fade" id="createTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-lg"></i> Nuevo Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTagForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="name" required placeholder="Ej: Urgente, FrÃ¡gil, VIP...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Empresa *</label>
                        <select class="form-select" name="company_id" required>
                            <option value="">Seleccionar empresa...</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color *</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <select class="form-select" name="color" id="colorSelect" required>
                                    <option value="">Seleccionar color...</option>
                                    <option value="primary">ðŸ”µ Azul</option>
                                    <option value="success">ðŸŸ¢ Verde</option>
                                    <option value="warning">ðŸŸ¡ Amarillo</option>
                                    <option value="danger">ðŸ”´ Rojo</option>
                                    <option value="info">ðŸ”µ Celeste</option>
                                    <option value="secondary">âš« Gris</option>
                                    <option value="dark">âš« Negro</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center h-100">
                                    <span class="badge bg-secondary" id="colorPreview">
                                        <i class="bi bi-tag"></i> Vista previa
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">DescripciÃ³n</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="DescripciÃ³n del tag y su uso...">
                        </textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            Tag activo
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Crear Tag
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Tag -->
<div class="modal fade" id="editTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTagForm">
                <div class="modal-body" id="editTagBody">
                    <!-- Contenido dinÃ¡mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-lg"></i> Actualizar Tag
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Detalles -->
<div class="modal fade" id="viewTagModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> Detalles del Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewTagBody">
                <!-- Contenido dinÃ¡mico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.tag-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.tag-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.color-option {
    display: inline-block;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin: 5px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.2s;
}

.color-option:hover,
.color-option.selected {
    border-color: #000;
}

.badge.fs-4 {
    font-size: 1.1rem !important;
}

.badge.fs-6 {
    font-size: 0.9rem !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentTagId = null;

// Preview del color en el formulario de creaciÃ³n
document.getElementById('colorSelect').addEventListener('change', function() {
    const color = this.value;
    const preview = document.getElementById('colorPreview');
    
    if (color) {
        preview.className = `badge bg-${color}`;
        preview.innerHTML = '<i class="bi bi-tag"></i> Vista previa';
    } else {
        preview.className = 'badge bg-secondary';
        preview.innerHTML = '<i class="bi bi-tag"></i> Vista previa';
    }
});

// Crear tag
document.getElementById('createTagForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Convertir checkbox
    data.is_active = formData.has('is_active');
    
    fetch('/admin/tags', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Tag creado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createTagModal')).hide();
            location.reload();
        } else {
            showAlert(data.message || 'Error al crear el tag', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al crear el tag', 'danger');
    });
});

// Editar tag
document.getElementById('editTagForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentTagId) return;
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Convertir checkbox
    data.is_active = formData.has('is_active');
    
    fetch(`/admin/tags/${currentTagId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Tag actualizado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editTagModal')).hide();
            location.reload();
        } else {
            showAlert(data.message || 'Error al actualizar el tag', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al actualizar el tag', 'danger');
    });
});

function toggleView(viewType) {
    const listView = document.getElementById('listView');
    const gridView = document.getElementById('gridView');
    const listBtn = document.getElementById('listViewBtn');
    const gridBtn = document.getElementById('gridViewBtn');
    
    if (viewType === 'grid') {
        listView.style.display = 'none';
        gridView.style.display = 'block';
        listBtn.classList.remove('active');
        gridBtn.classList.add('active');
    } else {
        listView.style.display = 'block';
        gridView.style.display = 'none';
        gridBtn.classList.remove('active');
        listBtn.classList.add('active');
    }
}

function viewTag(tagId) {
    fetch(`/admin/tags/${tagId}`)
        .then(response => response.json())
        .then(tag => {
            const modalBody = document.getElementById('viewTagBody');
            modalBody.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-info-circle"></i> InformaciÃ³n General</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3 text-center">
                                    <span class="badge bg-${tag.color} fs-3 p-3">
                                        <i class="bi bi-tag"></i> ${tag.name}
                                    </span>
                                </div>
                                <p><strong>Empresa:</strong> ${tag.company.name}</p>
                                <p><strong>Color:</strong> 
                                    <span class="badge bg-${tag.color}">${getColorName(tag.color)}</span>
                                </p>
                                <p><strong>Estado:</strong> 
                                    <span class="badge bg-${tag.is_active ? 'success' : 'secondary'}">
                                        ${tag.is_active ? 'Activo' : 'Inactivo'}
                                    </span>
                                </p>
                                <p><strong>DescripciÃ³n:</strong> ${tag.description || 'Sin descripciÃ³n'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> EstadÃ­sticas</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Equipos con este tag:</strong> ${tag.device_count}</p>
                                <p><strong>Creado:</strong> ${new Date(tag.created_at).toLocaleDateString('es-UY')}</p>
                                <p><strong>Actualizado:</strong> ${new Date(tag.updated_at).toLocaleDateString('es-UY')}</p>
                            </div>
                        </div>
                    </div>
                    ${tag.devices && tag.devices.length > 0 ? `
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-laptop"></i> Equipos con este Tag</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Equipo</th>
                                                <th>Estado</th>
                                                <th>UbicaciÃ³n</th>
                                                <th>DÃ­as</th>
                                                <th>Costo Actual</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tag.devices.map(device => `
                                                <tr>
                                                    <td>
                                                        <strong>${device.name}</strong>
                                                        <br><small class="text-muted">${device.serial_number || 'S/N: N/A'}</small>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-${getStatusColor(device.status)}">
                                                            ${device.status.replace('_', ' ')}
                                                        </span>
                                                    </td>
                                                    <td>${device.location ? device.location.name : 'Sin ubicaciÃ³n'}</td>
                                                    <td>${device.days_stored}</td>
                                                    <td>$${device.current_cost.toFixed(2)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('viewTagModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar los detalles del tag', 'danger');
        });
}

function editTag(tagId) {
    currentTagId = tagId;
    
    fetch(`/admin/tags/${tagId}`)
        .then(response => response.json())
        .then(tag => {
            const modalBody = document.getElementById('editTagBody');
            modalBody.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-control" name="name" value="${tag.name}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Color *</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <select class="form-select" name="color" id="editColorSelect" required>
                                <option value="primary" ${tag.color === 'primary' ? 'selected' : ''}>ðŸ”µ Azul</option>
                                <option value="success" ${tag.color === 'success' ? 'selected' : ''}>ðŸŸ¢ Verde</option>
                                <option value="warning" ${tag.color === 'warning' ? 'selected' : ''}>ðŸŸ¡ Amarillo</option>
                                <option value="danger" ${tag.color === 'danger' ? 'selected' : ''}>ðŸ”´ Rojo</option>
                                <option value="info" ${tag.color === 'info' ? 'selected' : ''}>ðŸ”µ Celeste</option>
                                <option value="secondary" ${tag.color === 'secondary' ? 'selected' : ''}>âš« Gris</option>
                                <option value="dark" ${tag.color === 'dark' ? 'selected' : ''}>âš« Negro</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center h-100">
                                <span class="badge bg-${tag.color}" id="editColorPreview">
                                    <i class="bi bi-tag"></i> ${tag.name}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">DescripciÃ³n</label>
                    <textarea class="form-control" name="description" rows="3">${tag.description || ''}</textarea>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="is_active" id="editIsActive" ${tag.is_active ? 'checked' : ''}>
                    <label class="form-check-label" for="editIsActive">
                        Tag activo
                    </label>
                </div>
            `;
            
            // Agregar event listener para el preview del color en ediciÃ³n
            document.getElementById('editColorSelect').addEventListener('change', function() {
                const color = this.value;
                const preview = document.getElementById('editColorPreview');
                preview.className = `badge bg-${color}`;
            });
            
            new bootstrap.Modal(document.getElementById('editTagModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar los datos del tag', 'danger');
        });
}

function confirmDeleteTag(tagId, tagName) {
    if (confirm(`Â¿EstÃ¡s seguro de que deseas eliminar el tag "${tagName}"?\n\nEste tag se eliminarÃ¡ de todos los equipos que lo tengan asignado.`)) {
        deleteTag(tagId);
    }
}

function deleteTag(tagId) {
    fetch(`/admin/tags/${tagId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Tag eliminado exitosamente', 'success');
            location.reload();
        } else {
            showAlert(data.message || 'Error al eliminar el tag', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al eliminar el tag', 'danger');
    });
}

function getStatusColor(status) {
    const colors = {
        'INGRESADO': 'primary',
        'ESPERANDO_A_RECIBIR': 'warning',
        'ALMACENADO': 'success',
        'ENVIADO': 'info',
        'RETIRADO': 'secondary'
    };
    return colors[status] || 'secondary';
}

function getColorName(color) {
    const names = {
        'primary': 'Azul',
        'success': 'Verde',
        'warning': 'Amarillo',
        'danger': 'Rojo',
        'info': 'Celeste',
        'secondary': 'Gris',
        'dark': 'Negro'
    };
    return names[color] || color;
}
</script>
{% endblock %}