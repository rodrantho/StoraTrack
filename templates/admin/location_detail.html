{% extends "base.html" %}

{% block title %}{{ location.name }} - Detalles{% endblock %}

{% block page_title %}{{ location.name }}{% endblock %}

{% block header_actions %}
<a href="{{ back_url }}" class="btn btn-outline-secondary me-2">
    <i class="bi bi-arrow-left"></i> Volver
</a>
<a href="/admin/locations/{{ location.id }}/edit" class="btn btn-warning">
    <i class="bi bi-pencil"></i> Editar
</a>
{% endblock %}

{% block content %}
<!-- Información básica -->
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Información de la Ubicación</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Nombre:</strong> {{ location.name }}</p>
                        <p><strong>Código:</strong> {{ location.code or 'No asignado' }}</p>
                        <p><strong>Tipo:</strong> {{ location.location_type.value if location.location_type else 'No especificado' }}</p>
                        <p><strong>Capacidad máxima:</strong> {{ location.max_capacity or 'Sin límite' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Número de estantes:</strong> {{ location.shelf_count or 'No especificado' }}</p>
                        <p><strong>Empresa:</strong> {{ location.primary_company.name if location.primary_company else 'No asignada' }}</p>
                        <p><strong>Ubicación padre:</strong> {{ location.parent.name if location.parent else 'Ubicación raíz' }}</p>
                        <p><strong>Creado:</strong> {{ location.created_at.strftime('%d/%m/%Y %H:%M') if location.created_at else 'No disponible' }}</p>
                    </div>
                </div>
                {% if location.description %}
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Descripción:</strong></p>
                        <p class="text-muted">{{ location.description }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Estadísticas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Estadísticas</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Dispositivos:</span>
                    <span class="badge bg-primary">{{ devices|length }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Sub-ubicaciones:</span>
                    <span class="badge bg-info">{{ children|length }}</span>
                </div>
                {% if location.max_capacity %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Ocupación:</span>
                    <span class="badge bg-{{ 'danger' if devices|length > location.max_capacity else 'success' }}">
                        {{ devices|length }}/{{ location.max_capacity }}
                    </span>
                </div>
                <div class="progress mb-2">
                    {% set percentage = (devices|length / location.max_capacity * 100) if location.max_capacity > 0 else 0 %}
                    <div class="progress-bar {{ 'bg-danger' if percentage > 100 else 'bg-success' }}" 
                         style="width: {{ min(percentage, 100) }}%"></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Dispositivos -->
{% if devices %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Dispositivos en esta ubicación</h5>
        <span class="badge bg-primary">{{ devices|length }}</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Código</th>
                        <th>Tipo</th>
                        <th>Estado</th>
                        <th>Empresa</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.name }}</td>
                        <td>{{ device.code or '-' }}</td>
                        <td>{{ device.device_type or '-' }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if device.status == 'active' else 'warning' if device.status == 'maintenance' else 'danger' }}">
                                {{ device.status.value if device.status else 'Sin estado' }}
                            </span>
                        </td>
                        <td>{{ device.company.name if device.company else '-' }}</td>
                        <td>
                            <a href="/admin/devices/{{ device.id }}" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Sub-ubicaciones -->
{% if children %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Sub-ubicaciones</h5>
        <span class="badge bg-info">{{ children|length }}</span>
    </div>
    <div class="card-body">
        <div class="row">
            {% for child in children %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card border-start border-info border-3">
                    <div class="card-body">
                        <h6 class="card-title">{{ child.name }}</h6>
                        {% if child.description %}
                        <p class="card-text text-muted small">{{ child.description[:100] }}{% if child.description|length > 100 %}...{% endif %}</p>
                        {% endif %}
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ child.location_type.value if child.location_type else 'Sin tipo' }}</small>
                            <a href="/admin/locations/{{ child.id }}" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if not devices and not children %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h5 class="mt-3">Ubicación vacía</h5>
        <p class="text-muted">Esta ubicación no contiene dispositivos ni sub-ubicaciones.</p>
    </div>
</div>
{% endif %}
{% endblock %}