{% extends "base.html" %}

{% block title %}Gestión de Ubicaciones{% endblock %}

{% block page_title %}Gestión de Ubicaciones{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLocationModal">
    <i class="bi bi-plus-lg"></i> Nueva Ubicación
</button>
{% endblock %}

{% block content %}
<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Buscar</label>
                <input type="text" class="form-control" name="search" value="{{ request.query_params.get('search', '') }}" placeholder="Nombre, descripción...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Empresa</label>
                <select class="form-select" name="company">
                    <option value="">Todas</option>
                    {% for company in companies %}
                    <option value="{{ company.id }}" {{ 'selected' if request.query_params.get('company') == company.id|string }}>{{ company.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Ubicación padre</label>
                <select class="form-select" name="parent">
                    <option value="">Todas</option>
                    <option value="root" {{ 'selected' if request.query_params.get('parent') == 'root' }}>Solo principales</option>
                    {% for location in parent_locations %}
                    <option value="{{ location.id }}" {{ 'selected' if request.query_params.get('parent') == location.id|string }}>{{ location.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Resumen -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h4 class="text-primary">{{ summary.total }}</h4>
                <small class="text-muted">Total Ubicaciones</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h4 class="text-success">{{ summary.with_devices }}</h4>
                <small class="text-muted">Con Equipos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h4 class="text-warning">{{ summary.main_locations }}</h4>
                <small class="text-muted">Principales</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h4 class="text-info">{{ summary.sub_locations }}</h4>
                <small class="text-muted">Sub-ubicaciones</small>
            </div>
        </div>
    </div>
</div>

<!-- Vista jerárquica de ubicaciones -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Estructura Jerárquica</h5>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="expandAll()">
                    <i class="bi bi-arrows-expand"></i> Expandir Todo
                </button>
                <button class="btn btn-outline-secondary" onclick="collapseAll()">
                    <i class="bi bi-arrows-collapse"></i> Colapsar Todo
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if locations %}
        <div class="location-tree">
            {% for location in locations %}
            {% if not location.parent_id %}
            {{ render_location_tree(location, locations, 0) }}
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-geo-alt text-muted" style="font-size: 3rem;"></i>
            <h5 class="text-muted mt-3">No hay ubicaciones registradas</h5>
            <p class="text-muted">Comienza creando la primera ubicación del sistema.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLocationModal">
                <i class="bi bi-plus-lg"></i> Crear Primera Ubicación
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Crear Ubicación -->
<div class="modal fade" id="createLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-lg"></i> Nueva Ubicación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createLocationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="name" required placeholder="Ej: Depósito Principal, Estantería A, Estante 1...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Empresa Principal</label>
                        <select class="form-select" name="company_id">
                            <option value="">Sin empresa principal...</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Empresa principal responsable de la ubicación (opcional)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Empresas con Acceso</label>
                        <select class="form-select" name="company_ids" multiple>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Selecciona múltiples empresas que pueden usar esta ubicación (mantén Ctrl para seleccionar varias)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ubicación padre</label>
                        <select class="form-select" name="parent_id" id="parentLocationSelect">
                            <option value="">Ubicación principal (sin padre)</option>
                            <!-- Se llenará dinámicamente según la empresa seleccionada -->
                        </select>
                        <small class="text-muted">Selecciona una ubicación padre para crear una jerarquía</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Ubicación</label>
                        <select class="form-select" name="location_type">
                            <option value="AREA">Área</option>
                            <option value="DEPOSITO">Depósito</option>
                            <option value="ESTANTERIA">Estantería</option>
                            <option value="ESTANTE">Estante</option>
                            <option value="CAJA">Caja</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Descripción detallada de la ubicación..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Código/Referencia</label>
                        <input type="text" class="form-control" name="code" placeholder="Código interno para identificar la ubicación">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Capacidad Máxima</label>
                                <input type="number" class="form-control" name="max_capacity" placeholder="Número máximo de equipos" min="0">
                                <small class="form-text text-muted">Cantidad máxima de equipos que puede almacenar</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Número de Estantes</label>
                                <input type="number" class="form-control" name="shelf_count" placeholder="Cantidad de estantes" min="0">
                                <small class="form-text text-muted">Para estanterías: número de estantes que contiene</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label">Orden</label>
                                <input type="number" class="form-control" name="sort_order" value="0" min="0">
                                <small class="text-muted">Para ordenar las ubicaciones</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            Ubicación activa
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Crear Ubicación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Ubicación -->
<div class="modal fade" id="editLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Ubicación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editLocationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="editLocationName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Empresa Principal</label>
                        <select class="form-select" id="editLocationCompany" name="company_id">
                            <option value="">Sin empresa principal...</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ubicación padre</label>
                        <select class="form-select" id="editLocationParent" name="parent_id">
                            <option value="">Ubicación principal (sin padre)</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Ubicación</label>
                        <select class="form-select" id="editLocationType" name="location_type">
                            <option value="AREA">Área</option>
                            <option value="DEPOSITO">Depósito</option>
                            <option value="ESTANTERIA">Estantería</option>
                            <option value="ESTANTE">Estante</option>
                            <option value="CAJA">Caja</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="editLocationDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Código/Referencia</label>
                        <input type="text" class="form-control" id="editLocationCode" name="code">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Capacidad Máxima</label>
                                <input type="number" class="form-control" id="editLocationCapacity" name="max_capacity" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Número de Estantes</label>
                                <input type="number" class="form-control" id="editLocationShelfCount" name="shelf_count" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-lg"></i> Actualizar Ubicación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Detalles -->
<div class="modal fade" id="viewLocationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> Detalles de Ubicación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información Básica</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Nombre:</strong></td>
                                <td id="viewLocationName">-</td>
                            </tr>
                            <tr>
                                <td><strong>Descripción:</strong></td>
                                <td id="viewLocationDescription">-</td>
                            </tr>
                            <tr>
                                <td><strong>Código:</strong></td>
                                <td id="viewLocationCode">-</td>
                            </tr>
                            <tr>
                                <td><strong>Tipo:</strong></td>
                                <td id="viewLocationType">-</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Relaciones</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Empresa:</strong></td>
                                <td id="viewLocationCompany">-</td>
                            </tr>
                            <tr>
                                <td><strong>Ubicación Padre:</strong></td>
                                <td id="viewLocationParent">-</td>
                            </tr>
                            <tr>
                                <td><strong>Creado:</strong></td>
                                <td id="viewLocationCreated">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Capacidad</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Capacidad Máxima:</strong></td>
                                <td id="viewLocationCapacity">-</td>
                            </tr>
                            <tr>
                                <td><strong>Número de Estantes:</strong></td>
                                <td id="viewLocationShelfCount">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger"></i> Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la ubicación <strong id="deleteLocationName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Advertencia:</strong> Esta acción eliminará también todas las sub-ubicaciones y no se puede deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.location-tree {
    padding: 15px;
}

.location-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 10px;
    background: white;
}

.location-header {
    padding: 12px 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.location-header:hover {
    background: #e9ecef;
}

.location-info {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.location-icon {
    margin-right: 10px;
    font-size: 1.2em;
}

.location-details {
    flex-grow: 1;
}

.location-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.location-meta {
    font-size: 0.85em;
    color: #6c757d;
}

.location-stats {
    display: flex;
    gap: 15px;
    margin-right: 15px;
}

.location-stat {
    text-align: center;
    font-size: 0.85em;
}

.location-stat-value {
    font-weight: 600;
    display: block;
}

.location-actions {
    display: flex;
    gap: 5px;
}

.location-children {
    padding: 15px;
    padding-left: 30px;
    background: #fafbfc;
    display: none;
}

.location-children.show {
    display: block;
}

.location-level-1 { margin-left: 20px; }
.location-level-2 { margin-left: 40px; }
.location-level-3 { margin-left: 60px; }
.location-level-4 { margin-left: 80px; }

.expand-icon {
    transition: transform 0.2s;
}

.expand-icon.expanded {
    transform: rotate(90deg);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let currentLocationId = null;

// Función para mostrar alertas
function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    if (alertContainer) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }
}

// Función para cargar ubicaciones
function loadLocations() {
    fetch('/api/locations')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('locationsContainer');
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-geo-alt text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">No hay ubicaciones registradas</h5>
                        <p class="text-muted">Comienza creando tu primera ubicación</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLocationModal">
                            <i class="bi bi-plus-circle"></i> Crear Primera Ubicación
                        </button>
                    </div>
                `;
            } else {
                // Renderizar ubicaciones jerárquicamente
                const hierarchicalData = buildLocationHierarchy(data);
                container.innerHTML = renderLocationTree(hierarchicalData);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar las ubicaciones', 'danger');
        });
}

// Función para construir jerarquía de ubicaciones
function buildLocationHierarchy(locations) {
    const locationMap = {};
    const rootLocations = [];
    
    // Crear mapa de ubicaciones
    locations.forEach(location => {
        location.children = [];
        locationMap[location.id] = location;
    });
    
    // Construir jerarquía
    locations.forEach(location => {
        if (location.parent_id && locationMap[location.parent_id]) {
            locationMap[location.parent_id].children.push(location);
        } else {
            rootLocations.push(location);
        }
    });
    
    return rootLocations;
}

// Función para renderizar árbol de ubicaciones
function renderLocationTree(locations, level = 0) {
    let html = '';
    locations.forEach(location => {
        html += `
            <div class="location-item location-level-${level}" data-location-id="${location.id}">
                <div class="location-header" onclick="toggleLocation(${location.id})">
                    <div class="location-info">
                        ${location.children.length > 0 ? 
                            `<i class="bi bi-chevron-right expand-icon" id="icon-${location.id}"></i>` :
                            `<i class="location-icon bi bi-geo-alt text-primary"></i>`
                        }
                        <div class="location-details">
                            <div class="location-name">${location.name}</div>
                            <div class="location-meta">
                                ${location.primary_company ? location.primary_company.name : 'Sin empresa asignada'}
                                ${location.code ? ` | ${location.code}` : ''}
                                ${location.description ? ` | ${location.description.substring(0, 50)}${location.description.length > 50 ? '...' : ''}` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="location-stats">
                        <div class="location-stat">
                            <span class="location-stat-value text-primary">${location.device_count || 0}</span>
                            <small class="text-muted">Equipos</small>
                        </div>
                        ${location.children.length > 0 ? `
                            <div class="location-stat">
                                <span class="location-stat-value text-info">${location.children.length}</span>
                                <small class="text-muted">Sub-ubicaciones</small>
                            </div>
                        ` : ''}
                    </div>
                    <div class="location-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-outline-info btn-sm" onclick="viewLocation(${location.id})" title="Ver detalles">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="editLocation(${location.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteLocation(${location.id}, '${location.name}')" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                ${location.children.length > 0 ? `
                    <div class="location-children" id="children-${location.id}" style="display: none;">
                        ${renderLocationTree(location.children, level + 1)}
                    </div>
                ` : ''}
            </div>
        `;
    });
    return html;
}

// Función para cargar empresas
function loadCompanies() {
    fetch('/api/companies')
        .then(response => response.json())
        .then(companies => {
            const selects = ['createLocationCompany', 'editLocationCompany'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar empresa...</option>';
                    companies.forEach(company => {
                        select.innerHTML += `<option value="${company.id}">${company.name}</option>`;
                    });
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// Función para alternar expansión de ubicaciones
function toggleLocation(locationId) {
    const locationItem = document.querySelector(`[data-location-id="${locationId}"]`);
    const childrenContainer = document.getElementById(`children-${locationId}`);
    const icon = document.getElementById(`icon-${locationId}`);
    
    if (childrenContainer) {
        const isExpanded = childrenContainer.style.display !== 'none';
        
        if (isExpanded) {
            childrenContainer.style.display = 'none';
            icon.className = 'bi bi-chevron-right expand-icon';
            locationItem.classList.remove('expanded');
        } else {
            childrenContainer.style.display = 'block';
            icon.className = 'bi bi-chevron-down expand-icon';
            locationItem.classList.add('expanded');
        }
    }
}

// Funciones globales - FUERA del DOMContentLoaded para que sean accesibles desde HTML
function confirmDeleteLocation(locationId, locationName) {
    // Establecer el nombre de la ubicación en el modal
    document.getElementById('deleteLocationName').textContent = locationName;
    
    // Guardar el ID de la ubicación para usar en la confirmación
    currentLocationId = locationId;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    modal.show();
}

function deleteLocation(locationId) {
    fetch(`/admin/locations/${locationId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al eliminar la ubicación');
        }
        return response.json();
    })
    .then(data => {
         showAlert('Ubicación eliminada exitosamente', 'success');
         location.reload(); // Recargar la página
     })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al eliminar la ubicación', 'danger');
    });
}

function viewLocation(locationId) {
    fetch(`/admin/locations/${locationId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener la ubicación');
            }
            return response.json();
        })
        .then(location => {
            document.getElementById('viewLocationName').textContent = location.name;
            document.getElementById('viewLocationDescription').textContent = location.description || 'Sin descripción';
            document.getElementById('viewLocationCode').textContent = location.code || 'Sin código';
            document.getElementById('viewLocationType').textContent = location.location_type || 'Sin tipo';
            document.getElementById('viewLocationCompany').textContent = location.primary_company ? location.primary_company.name : 'Sin empresa asignada';
            document.getElementById('viewLocationParent').textContent = location.parent ? location.parent.name : 'Ubicación principal';
            document.getElementById('viewLocationCreated').textContent = location.created_at ? new Date(location.created_at).toLocaleDateString() : 'Sin fecha';
            document.getElementById('viewLocationCapacity').textContent = location.max_capacity || 'Sin límite';
            document.getElementById('viewLocationShelfCount').textContent = location.shelf_count || 'No especificado';
            
            const modal = new bootstrap.Modal(document.getElementById('viewLocationModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar los datos de la ubicación', 'danger');
        });
}

function editLocation(locationId) {
    currentLocationId = locationId;
    
    fetch(`/admin/locations/${locationId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener la ubicación');
            }
            return response.json();
        })
        .then(location => {
            document.getElementById('editLocationName').value = location.name;
            document.getElementById('editLocationDescription').value = location.description || '';
            document.getElementById('editLocationCode').value = location.code || '';
            document.getElementById('editLocationType').value = location.location_type || 'AREA';
            document.getElementById('editLocationCompany').value = location.company_id || '';
            document.getElementById('editLocationParent').value = location.parent_id || '';
            document.getElementById('editLocationCapacity').value = location.max_capacity || '';
            document.getElementById('editLocationShelfCount').value = location.shelf_count || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editLocationModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar los datos de la ubicación', 'danger');
        });
}

// Función para manejar el envío del formulario de edición
function handleEditLocationSubmit() {
    const form = document.getElementById('editLocationForm');
    const formData = new FormData(form);
    
    const locationData = {
        name: formData.get('name'),
        description: formData.get('description'),
        code: formData.get('code'),
        location_type: formData.get('location_type'),
        company_id: formData.get('company_id') || null,
        parent_id: formData.get('parent_id') || null,
        max_capacity: formData.get('max_capacity') ? parseInt(formData.get('max_capacity')) : null,
        shelf_count: formData.get('shelf_count') ? parseInt(formData.get('shelf_count')) : null
    };
    
    fetch(`/admin/locations/${currentLocationId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(locationData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al actualizar la ubicación');
        }
        return response.json();
    })
    .then(data => {
        showAlert('Ubicación actualizada exitosamente', 'success');
        const modal = bootstrap.Modal.getInstance(document.getElementById('editLocationModal'));
        modal.hide();
        location.reload(); // Recargar la página
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al actualizar la ubicación', 'danger');
    });
}

function toggleLocation(locationId) {
    const locationItem = document.querySelector(`[data-location-id="${locationId}"]`);
    if (locationItem) {
        const children = locationItem.querySelector('.location-children');
        const expandIcon = locationItem.querySelector('.expand-icon');
        
        if (children) {
            if (children.style.display === 'none') {
                children.style.display = 'block';
                expandIcon.classList.remove('bi-chevron-right');
                expandIcon.classList.add('bi-chevron-down');
            } else {
                children.style.display = 'none';
                expandIcon.classList.remove('bi-chevron-down');
                expandIcon.classList.add('bi-chevron-right');
            }
        }
    }
}

function expandAll() {
    document.querySelectorAll('.location-children').forEach(children => {
        children.style.display = 'block';
    });
    document.querySelectorAll('.expand-icon').forEach(icon => {
        icon.classList.remove('bi-chevron-right');
        icon.classList.add('bi-chevron-down');
    });
}

function collapseAll() {
    document.querySelectorAll('.location-children').forEach(children => {
        children.style.display = 'none';
    });
    document.querySelectorAll('.expand-icon').forEach(icon => {
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-right');
    });
}

function getStatusColor(status) {
    const colors = {
        'INGRESADO': 'primary',
        'ESPERANDO_A_RECIBIR': 'warning',
        'ALMACENADO': 'success',
        'ENVIADO': 'info',
        'RETIRADO': 'secondary'
    };
    return colors[status] || 'secondary';
}

document.addEventListener('DOMContentLoaded', function() {

    // Manejar cambio de empresa en el formulario de creación
    const companySelect = document.querySelector('select[name="company_id"]');
    if (companySelect) {
        companySelect.addEventListener('change', function() {
            const companyId = this.value;
            const parentSelect = document.getElementById('parentLocationSelect');
            
            // Limpiar opciones existentes
            parentSelect.innerHTML = '<option value="">Ubicación principal (sin padre)</option>';
            
            if (companyId) {
                // Cargar ubicaciones de la empresa seleccionada
                fetch(`/admin/locations/by-company/${companyId}`)
                    .then(response => response.json())
                    .then(locations => {
                        locations.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location.id;
                            option.textContent = location.full_path || location.name;
                            parentSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading locations:', error);
                    });
            }
        });
    }

// Crear ubicación usando el manejador estandarizado
new FormHandler('createLocationForm', {
    url: '/admin/locations',
    method: 'POST',
    useFormData: false, // Usar JSON
    successMessage: 'Ubicación creada exitosamente',
    errorMessage: 'Error al crear la ubicación'
});

// Editar ubicación usando el manejador estandarizado
new FormHandler('editLocationForm', {
    url: () => `/admin/locations/${currentLocationId}`,
    method: 'PUT',
    useFormData: false, // Usar JSON
    successMessage: 'Ubicación actualizada exitosamente',
    errorMessage: 'Error al actualizar la ubicación',
    onSubmit: function() {
        if (!currentLocationId) {
            throw new Error('No se ha seleccionado una ubicación');
        }
    }
});

// Event listener para el botón de confirmación de eliminación
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', function() {
        if (currentLocationId) {
            deleteLocation(currentLocationId);
            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
            modal.hide();
        }
    });
}

}); // Fin del DOMContentLoaded
</script>
{% endblock %}

{% macro render_location_tree(location, all_locations, level) %}
<div class="location-item location-level-{{ level }}">
    <div class="location-header" onclick="toggleLocation({{ location.id }})">
        <div class="location-info">
            {% if location.children %}
            <i class="bi bi-chevron-right expand-icon" id="icon-{{ location.id }}"></i>
            {% else %}
            <i class="location-icon bi bi-geo-alt text-primary"></i>
            {% endif %}
            <div class="location-details">
                <div class="location-name">{{ location.name }}</div>
                <div class="location-meta">
                    {% if location.primary_company %}{{ location.primary_company.name }}{% else %}Sin empresa asignada{% endif %}
                    {% if location.code %} | {{ location.code }}{% endif %}
                    {% if location.description %} | {{ location.description[:50] }}{% if location.description|length > 50 %}...{% endif %}{% endif %}
                </div>
            </div>
        </div>
        <div class="location-stats">
            <div class="location-stat">
                <span class="location-stat-value text-primary">{{ location.device_count }}</span>
                <small class="text-muted">Equipos</small>
            </div>
            {% if location.children %}
            <div class="location-stat">
                <span class="location-stat-value text-info">{{ location.children|length }}</span>
                <small class="text-muted">Sub-ubicaciones</small>
            </div>
            {% endif %}
        </div>
        <div class="location-actions" onclick="event.stopPropagation()">
            <button class="btn btn-outline-info btn-sm" onclick="viewLocation({{ location.id }})" title="Ver detalles">
                <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-outline-warning btn-sm" onclick="editLocation({{ location.id }})" title="Editar">
                <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteLocation({{ location.id }}, '{{ location.name }}')" title="Eliminar">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
    {% if location.children %}
    <div class="location-children" id="children-{{ location.id }}">
        {% for child in location.children %}
        {{ render_location_tree(child, all_locations, level + 1) }}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endmacro %}